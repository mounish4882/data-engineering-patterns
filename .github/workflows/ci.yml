name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black pylint mypy isort flake8 bandit safety
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

    - name: Check code formatting with Black
      run: |
        black --check --line-length 100 . || echo "Black formatting issues found"

    - name: Check import ordering with isort
      run: |
        isort --check-only --profile black . || echo "Import ordering issues found"

    - name: Lint with Pylint
      run: |
        find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" | xargs pylint --disable=all --enable=E,F --exit-zero

    - name: Type check with MyPy
      run: |
        mypy --ignore-missing-imports --no-strict-optional . || echo "Type checking issues found"

    - name: Security check with Bandit
      run: |
        bandit -r . -x "./venv/*,./.venv/*,./tests/*" -ll || echo "Security issues found"

    - name: Check dependencies with Safety
      run: |
        safety check --json || echo "Dependency vulnerabilities found"

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: code-quality

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-mock coverage
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

    - name: Run unit tests
      env:
        DATABASE_URL: postgresql://testuser:testpass@localhost:5432/testdb
      run: |
        pytest tests/ -v --cov=. --cov-report=xml --cov-report=html --cov-report=term-missing || echo "Tests failed"

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker images
      run: |
        # Build all Docker images in the repository
        find . -name "Dockerfile" -not -path "./node_modules/*" | while read dockerfile; do
          dir=$(dirname "$dockerfile")
          echo "Building Docker image in $dir"
          docker build -t test-image:latest "$dir" || echo "Build failed for $dir"
        done

  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Lint Markdown files
      uses: actionshub/markdownlint@main

  link-checker:
    name: Check Links
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check links in Markdown files
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        config-file: '.github/markdown-link-check-config.json'
        folder-path: '.'

  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [code-quality, test, docker-build, markdown-lint]
    if: always()

    steps:
    - name: Check job status
      run: |
        echo "Code Quality: ${{ needs.code-quality.result }}"
        echo "Tests: ${{ needs.test.result }}"
        echo "Docker Build: ${{ needs.docker-build.result }}"
        echo "Markdown Lint: ${{ needs.markdown-lint.result }}"

    - name: Create status summary
      run: |
        if [ "${{ needs.code-quality.result }}" == "success" ] && [ "${{ needs.test.result }}" == "success" ]; then
          echo "✅ All checks passed!"
        else
          echo "⚠️ Some checks failed. Please review the logs."
        fi
